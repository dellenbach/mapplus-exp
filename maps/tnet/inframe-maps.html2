<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Karten</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="inframe-maps.css?v=20260113">
</head>
<body>
  <script src="tnet-mapplus-helpers.js"></script>
  <script>
    (function() {
      var loginTriggered = false;
      var interval = setInterval(function() {
        if (typeof moOAuthLoginNew === 'function' && !loginTriggered) {
          moOAuthLoginNew('adfs','');
          loginTriggered = true;
          clearInterval(interval);
        }
      }, 200);
    })();
  </script>
  <script>
    (function() {
      var loginTriggered = false;
      var interval = setInterval(function() {
        if (typeof moOAuthLoginNew === 'function' && !loginTriggered) {
          moOAuthLoginNew('adfs','');
          loginTriggered = true;
          clearInterval(interval);
        }
      }, 200);
    })();
  </script>
  <div class="container">
    <div class="panel">
      <h2>Kategorien</h2>
      <div class="panel-body">
        <div id="navigation" style="display: none;"></div>
      </div>
    </div>
    <div class="panel">
      <div class="panel-header">
        <div class="header-row">
          <h2>Karten</h2>
          <div id="map-buttons"></div>
          <button id="reload-btn" title="iframe neu laden (nach Anmeldung)">↻ Reload</button>
        </div>
      </div>
      <div class="panel-body">
        <div id="extracted"></div>
      </div>
    </div>
  </div>
  
  <iframe id="mapFrame" src="https://www.gis-daten.ch/?active-map=nw" style="display:none;"></iframe>

  <script>
    // Reload-Button Funktionalität
    document.getElementById('reload-btn').addEventListener('click', function() {
      const iframe = document.getElementById('mapFrame');
      // Nach Reload sofort und öfter extrahieren für geschützte Inhalte
      iframe.src = iframe.src;
      setTimeout(extractContent, 500);
      setTimeout(extractContent, 1500);
      setTimeout(extractContent, 3000);
      setTimeout(extractContent, 5000);
    });
    
    // Auto-Reload wenn Tab wieder in Fokus kommt (für SSO-Sessions)
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
        // Tab ist wieder sichtbar - iframe neuladen für aktuelle Session
        setTimeout(function() {
          const iframe = document.getElementById('mapFrame');
          iframe.src = iframe.src;
          setTimeout(extractContent, 500);
          setTimeout(extractContent, 1500);
          setTimeout(extractContent, 3000);
        }, 100);
      }
    });
    
    let activeMapButton = 'nw';  // Initialisiere mit 'nw' statt null
    
    // Automatische Extraktion nach Verzögerung für asynchrone Inhalte
    document.getElementById('mapFrame').addEventListener('load', function() {
      // Erste Extraktion sofort
      extractContent();
      // Zweite Extraktion nach 2 Sekunden für nachgeladene Inhalte
      setTimeout(extractContent, 2000);
      // Dritte Extraktion nach 4 Sekunden für langsam ladende Elemente
      setTimeout(extractContent, 4000);
    });

    function extractContent() {
      try {
        const doc = document.getElementById('mapFrame').contentDocument;
        if (!doc) throw new Error('iFrame nicht verfügbar');
        
        // Navigation extrahieren - hole den Container mit beiden Kantonen
        const navNW = doc.querySelector("div.cdt-frontpage-maps-sidebar-nav-nw");
        const navOW = doc.querySelector("div.cdt-frontpage-maps-sidebar-nav-ow");
        
        console.log('activeMapButton:', activeMapButton);
        console.log('navNW gefunden:', !!navNW);
        console.log('navOW gefunden:', !!navOW);
        
        // Wähle die richtige Navigation basierend auf activeMapButton
        let navEl = null;
        if (activeMapButton === 'nw' && navNW) {
          navEl = navNW;
          console.log('Verwende NW Navigation');
        } else if (activeMapButton === 'ow' && navOW) {
          navEl = navOW;
          console.log('Verwende OW Navigation');
        }
        
        if (!navEl) {
          console.error('Keine Navigation gefunden für:', activeMapButton);
          throw new Error('Navigation für ' + activeMapButton.toUpperCase() + ' nicht gefunden');
        }
        
        // Navigation im iFrame ausblenden (NACH der Extraktion)
        const navStyle = doc.createElement('style');
        navStyle.textContent = '.cdt-frontpage-maps-sidebar { display: none !important; }';
        doc.head.appendChild(navStyle);
        
        // Kartenbereich extrahieren
        const cardsEl = doc.querySelector("body > div.cdt-wrapper > main > article > div > div > div.cdt-frontpage-maps-wrapper > div.cdt-frontpage-maps-content > div.cdt-frontpage-maps-maplists");
        
        if (!cardsEl) {
          throw new Error('Kartenbereich "div.cdt-frontpage-maps-maplists" nicht gefunden');
        }
        
        // Buttons extrahieren
        const btnContainer = doc.querySelector("body > div.cdt-wrapper > main > article > div > div > div.cdt-frontpage-maps-wrapper > div.cdt-frontpage-maps-content > div.cdt-frontpage-maps-header > div.cdt-frontpage-maps-header-buttons");
        
        let mapButtons = '';
        if (btnContainer) {
          mapButtons = btnContainer.outerHTML;
        }
        
        // Sammle alle Stylesheets und Styles
        const stylesheets = collectStylesheets(doc);
        const inlineStyles = collectInlineStyles(doc);
        
        // Zusätzliche Styles für Ausblendungen
        const hideStyles = `
          <style>
            #extracted > div > article > header > div.breadcrumbs > ul { display: none !important; }
            #navigation ul, #navigation li { list-style: none !important; margin: 0 !important; padding: 0 !important; }
            #navigation li::before, #navigation li::marker { display: none !important; }
          </style>
        `;
        
        // Navigation - extrahiere Links direkt und erstelle einfache Buttons
        const navLinks = navEl.querySelectorAll('a[href]');
        let navHtml = '';
        navLinks.forEach(link => {
          const href = link.getAttribute('href');
          const text = link.textContent.trim();
          navHtml += `<button data-href="${href}">${text}</button>`;
        });
        console.log('navHtml Länge:', navHtml.length);
        console.log('Anzahl Buttons:', navLinks.length);
        
        // Karten-HTML: Links und onclick Handler ersetzen BEVOR es ins DOM kommt
        let cardsHtml = cardsEl.innerHTML;
        
        // Regex 1: href="https://www.gis-daten.ch/secmap/XXX" oder href="https://www.gis-daten.ch/map/XXX"
        // Ersetze durch onclick="TnetSetBookmark('XXX'); window.top.closeMapsInfoDialog(); return false;" href="javascript:void(null)"
        cardsHtml = cardsHtml.replace(
          /(<a[^>]*href=")https:\/\/www\.gis-daten\.ch\/(secmap|map)\/([^"]+)("[^>]*)(target="_blank")?([^>]*>)/g,
          function(match, before, type, bookmarkId, after1, targetBlank, after2) {
            // Entferne target="_blank" wenn vorhanden
            const cleanAfter = (after1 + (after2 || '')).replace(/\s*target="_blank"\s*/g, '');
            return `${before}javascript:void(null)" onclick="TnetSetBookmark('${bookmarkId}'); window.top.closeMapsInfoDialog(); return false;"${cleanAfter}>`;
          }
        );
        
        // Regex 2: onclick="window.top.njs.AppManager.setMapBookmark(['main'], 'map=XXX&amp;group=YYY')"
        // Ersetze durch onclick="TnetSetBookmark('XXX'); window.top.closeMapsInfoDialog(); return false;"
        cardsHtml = cardsHtml.replace(
          /onclick="window\.top\.njs\.AppManager\.setMapBookmark\(\s*\[[^\]]*\]\s*,\s*'map=([^&']+)[^']*'\s*\);[^"]*"/g,
          function(match, bookmarkId) {
            return `onclick="TnetSetBookmark('${bookmarkId}'); window.top.closeMapsInfoDialog(); return false;"`;
          }
        );
        
        // Navigation mit Styles
        const navContent = `
          <style>
            #navigation button { 
              display: block !important; 
              width: 100%;
              text-align: left;
              padding: 10px 15px !important; 
              margin: 2px 0 !important; 
              background: #ffffff;
              border: none;
              border-left: 3px solid transparent;
              cursor: pointer;
              font-size: 14px;
              color: #333;
              transition: all 0.2s;
            }
            #navigation button:hover {
              background: #f5f5f5;
              border-left-color: #0066cc;
            }
            #navigation button.active {
              background: #e6f2ff;
              border-left-color: #0066cc;
              font-weight: 600;
            }
          </style>
          <div style="font-family: inherit; color: inherit;">${navHtml}</div>
        `;
        
        // Karten mit Styles und Ausblendungen
        const cardsContent = `
          ${stylesheets}
          ${inlineStyles}
          ${hideStyles}
          <div style="font-family: inherit; color: inherit;">${cardsHtml}</div>
        `;
        
        // Fade-out
        document.getElementById('extracted').style.opacity = '0';
        
        setTimeout(() => {
          document.getElementById('navigation').innerHTML = navContent;
          document.getElementById('navigation').style.display = 'block'; // Navigation jetzt anzeigen
          document.getElementById('extracted').innerHTML = cardsContent;
          document.getElementById('map-buttons').innerHTML = mapButtons;
          
          console.log('Navigation eingefügt. Buttons gefunden:', document.querySelectorAll('#navigation button').length);
          console.log('Navigation innerHTML Länge:', document.getElementById('navigation').innerHTML.length);
          
          // Links mit href verarbeiten (für Navigation)
          processExtractedLinks('#extracted a[href]');
          
          // Buttons neu binden mit Event-Listenern
          attachButtonListeners();
          
          // Setze den aktiven Button basierend auf activeMapButton
          const buttons = document.querySelectorAll('#map-buttons button');
          buttons.forEach(btn => {
            const classList = Array.from(btn.classList);
            if ((activeMapButton === 'nw' && classList.some(cls => cls.includes('nw'))) ||
                (activeMapButton === 'ow' && classList.some(cls => cls.includes('ow')))) {
              btn.classList.add('active');
            } else {
              btn.classList.remove('active');
            }
          });
          
          // Zeige den richtigen Karten-Bereich
          const nwDiv = document.querySelector('#extracted > div > div.cdt-frontpage-maps-maplist-nw');
          const owDiv = document.querySelector('#extracted > div > div.cdt-frontpage-maps-maplist-ow');
          if (activeMapButton === 'nw' && nwDiv) {
            nwDiv.classList.add('active');
            if (owDiv) owDiv.classList.remove('active');
          } else if (activeMapButton === 'ow' && owDiv) {
            owDiv.classList.add('active');
            if (nwDiv) nwDiv.classList.remove('active');
          }
          
          // Fade-in
          document.getElementById('extracted').style.opacity = '1';
        }, 150);
        
      } catch (e) {
        document.getElementById('extracted').innerHTML = '<p style="color:#d9534f">' + e.message + '</p>';
        document.getElementById('navigation').innerHTML = '<p style="color:#d9534f">' + e.message + '</p>';
        document.getElementById('extracted').style.opacity = '1';
      }
    }

    // convertLinksToButtons ist jetzt in tnet-mapplus-helpers.js

    function attachButtonListeners() {
      // Finde alle Buttons in der Navigation
      const buttons = document.querySelectorAll('#navigation button');
      
      // Map-Filter-Buttons binden
      const mapButtons = document.querySelectorAll('#map-buttons button');
      mapButtons.forEach(mapBtn => {
        // Extrahiere den Kartennamen aus Button-Klassen oder Attributen
        const classList = Array.from(mapBtn.classList);
        const isNW = classList.some(cls => cls.includes('nw'));
        const isOW = classList.some(cls => cls.includes('ow'));
        
        if (isNW) {
          mapBtn.onclick = function() {
            activeMapButton = 'nw';
            // Entferne active Klasse von allen Map-Buttons
            document.querySelectorAll('#map-buttons button').forEach(btn => btn.classList.remove('active'));
            mapBtn.classList.add('active');
            
            // Lade NW-URL im iframe
            document.getElementById('mapFrame').src = 'https://www.gis-daten.ch/?active-map=nw';
          };
          
          // Wenn es der NW Button ist, speichere die Referenz für später
          if (!window.nwButton) window.nwButton = mapBtn;
        } else if (isOW) {
          mapBtn.onclick = function() {
            activeMapButton = 'ow';
            // Entferne active Klasse von allen Map-Buttons
            document.querySelectorAll('#map-buttons button').forEach(btn => btn.classList.remove('active'));
            mapBtn.classList.add('active');
            
            // Lade OW-URL im iframe
            document.getElementById('mapFrame').src = 'https://www.gis-daten.ch/?active-map=ow';
          };
        }
      });
      
      buttons.forEach(button => {
        const href = button.getAttribute('data-href');
        
        if (href) {
          // Prüfe ob es eine Sprungmarke ist (Anker-Link)
          if (href.startsWith('#')) {
            // Sprungmarke: Scrolle im extrahierten Content zur Ziel-ID
            button.onclick = function() {
              // Entferne active Klasse von allen Buttons
              buttons.forEach(btn => btn.classList.remove('active'));
              // Setze active Klasse auf diesen Button
              button.classList.add('active');
              
              // Suche das Element nur im aktuell extrahierten Inhalt
              const targetElement = document.querySelector('#extracted ' + href);
              
              if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth' });
                // Markiere das Ziel-Element kurz
                targetElement.classList.add('highlight');
                targetElement.style.backgroundColor = 'rgba(255, 0, 0, 0.15)';
                setTimeout(() => {
                  targetElement.style.backgroundColor = 'rgba(255, 0, 0, 0)';
                }, 100);
                setTimeout(() => {
                  targetElement.classList.remove('highlight');
                  targetElement.style.backgroundColor = '';
                }, 2100);
              } else {
                console.log('Target element not found:', href);
              }
            };
          } else {
            // Normaler Link: Navigiere im iFrame zur Ziel-URL
            button.onclick = function() {
              // Entferne active Klasse von allen Buttons
              buttons.forEach(btn => btn.classList.remove('active'));
              // Setze active Klasse auf diesen Button
              button.classList.add('active');
              
              document.getElementById('mapFrame').src = href;
              // Nach Navigation warten und neu extrahieren
              setTimeout(extractContent, 2000);
            };
          }
        }
      });
    }
  </script>
  <script>
    // Automatischer Klick auf den Anmelde-Button - nur wenn group=*pro in URL
    (function() {
      // Prüfe die Browser-Adresszeile (URL des Elternfensters)
      var browserUrl = '';
      try {
        browserUrl = window.top.location.href;
      } catch(e) {
        // Falls Cross-Origin, versuche parent
        try {
          browserUrl = window.parent.location.href;
        } catch(e2) {
          // Falls auch das nicht geht, verwende eigene URL
          browserUrl = window.location.href;
        }
      }
      
      var proGroupFound = hasProGroup(browserUrl);
      
      console.log('Prüfe Browser-Adresszeile:', browserUrl, '- group=*pro gefunden:', proGroupFound);
      
      if (!proGroupFound) {
        console.log('Kein group=*pro in Browser-URL - kein automatischer Login');
        return;
      }
      
      console.log('group=*pro erkannt - versuche automatischen Login');
      
      var loginClicked = false;
      var attempts = 0;
      var maxAttempts = 50; // 10 Sekunden (50 x 200ms)
      
      var interval = setInterval(function() {
        attempts++;
        
        if (loginClicked || attempts >= maxAttempts) {
          clearInterval(interval);
          return;
        }
        
        // Suche den Anmelde-Button im mapFrame
        var mapFrame = document.getElementById('mapFrame');
        if (!mapFrame) return;
        
        if (tryAutoLogin(mapFrame)) {
          loginClicked = true;
          clearInterval(interval);
          console.log('Login-Button geklickt - Session wird übernommen');
        }
      }, 200);
    })();
  </script>
</body>
</html>
