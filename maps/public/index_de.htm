<!DOCTYPE HTML>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <link rel="preconnect" href="https://www.gis-daten.ch" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="dns-prefetch" href="//www.gis-daten.ch">
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <title>MAP+ GIS Daten AG</title>
    
    <!-- Critical CSS für Splash Screen - inline für sofortige Anzeige -->
    <style>
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #4b7b81 0%, #3a6268 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            transition: opacity 1s ease, visibility 1s ease, transform 1s ease;
        }
        #splash-screen.hidden {
            opacity: 0;
            visibility: hidden;
            transform: scale(1.05);
        }
        #splash-logo {
            position: relative;
            margin-bottom: 10px;
        }
        #splash-logo img {
            width: 200px;
            height: auto;
            filter: brightness(0) invert(1);
        }
        /* Drehender Cube auf dem I von GIS */
        #splash-cube {
            width: 32px;
            height: 32px;
            position: absolute;
            top: -3px;
            left: 50%;
            margin-left: -16px;
            transform-style: preserve-3d;
            animation: splashRotate 1s infinite linear;
        }
        #splash-cube .cube-face {
            position: absolute;
            width: 32px;
            height: 32px;
            backface-visibility: hidden;
        }
        #splash-cube .cube-front { transform: rotateY(0deg) translateZ(16px); background: #e8423f; }
        #splash-cube .cube-back { transform: rotateY(180deg) translateZ(16px); background: #8a0000; }
        #splash-cube .cube-left { transform: rotateY(-90deg) translateZ(16px); background: #8a0000; }
        #splash-cube .cube-right { transform: rotateY(90deg) translateZ(16px); background: #ffe4e4; }
        #splash-cube .cube-top { transform: rotateX(90deg) translateZ(16px); background: #f69f9f; }
        #splash-cube .cube-bottom { transform: rotateX(-90deg) translateZ(16px); background: #8a0000; }
        @keyframes splashRotate {
            from { transform: rotateX(-30deg) rotateY(0deg); }
            to { transform: rotateX(-30deg) rotateY(360deg); }
        }
        #splash-title {
            color: white;
            font-family: 'Roboto', Arial, sans-serif;
            font-size: 42px;
            font-weight: 300;
            letter-spacing: 8px;
            margin-top: 20px;
            margin-bottom: 40px;
        }
        #splash-loader {
            width: 200px;
            height: 4px;
            background: rgba(255,255,255,0.15);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 60px;
            box-shadow: 0 0 10px rgba(255,255,255,0.1);
        }
        #splash-loader-bar {
            width: 30%;
            height: 100%;
            background: linear-gradient(90deg, rgba(255,255,255,0.3), white, rgba(255,255,255,0.3));
            border-radius: 4px;
            animation: loading 1.5s ease-in-out infinite;
            box-shadow: 0 0 8px rgba(255,255,255,0.5);
        }
        @keyframes loading {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(400%); }
        }
        }
    </style>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v10.6.0/ol.css"
        onerror="this.href='/mapplus-lib/openlayers/v10.6.0-package/ol.css';">

    <!--
	Layout CSS linking a template and custom layout: to be integrated
  -->
    <link rel="stylesheet" type="text/css"
        href="/mapplus-lib/dojo-release/dojo-release-1.17.3/dijit/themes/tundra/tundra.css" />
    <link rel="stylesheet" type="text/css"
        href="/mapplus-lib/dojo-release/dojo-release-1.17.3/dojox/widget/ColorPicker/ColorPicker.css" />
    <link rel="shortcut icon" href="favicon.png?" />
    <!-- google fonts - Roboto als Hauptschrift -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!--
	Layout CSS dojo FloatingPane module
  -->
    <link rel="stylesheet" href="../core/templates/nwow_floating/css/FloatingPane.css" />
    
    <!--
	Layout CSS dojo Dialog module
  -->
    <link rel="stylesheet" href="../core/templates/nwow_floating/css/Dialog.css" />
    <!--
	Layout CSS Disclaimer module
  -->
    <link rel="stylesheet" href="../core/templates/nwow_floating/css/Disclaimer.css" />
    <!--
	Layout CSS dojo checkboxtree module
  -->
    <link rel="stylesheet" href="../core/templates/nwow_floating/css/InfoWindow.css" />
    <!--
	POI Manager CSS for icons
  -->
    <link rel="stylesheet" href="../core/templates/nwow_floating/css/PoiManager.css" />
    <!--
	Layout CSS classic Layermanager module
  -->
    <link rel="stylesheet" href="../core/templates/nwow_floating/css/ClassicLayerMgr.css" />
    <!--
	ScaleBar CSS
  -->
    <link rel="stylesheet" type="text/css" href="../core/templates/nwow_floating/css/style.css" />
    <!--
	Layout CSS for search params grids
  -->
    <style type="text/css">
        @import "../core/templates/nwow_floating/css/tundraGrid.css";
        @import "/mapplus-lib/dojo-release/dojo-release-1.17.3/dojox/grid/enhanced/resources/tundra/EnhancedGrid.css";
        @import "/mapplus-lib/dojo-release/dojo-release-1.17.3/dojox/grid/enhanced/resources/EnhancedGrid_rtl.css";
    </style>

    <!-- load this javascript before dojo to avoid multidefine error -->
    <!-- jspdf for preview-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- filesaver-js -->
    <script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.12.1/proj4.min.js" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <script>window.proj4 || document.write('<script src="/mapplus-lib/proj4js/2.12.1/dist/proj4.js">\x3C/script>')</script>
    <script src="//cdn.jsdelivr.net/npm/ol@v10.6.0/dist/ol.js"></script>
    <script>window.ol || document.write('<script src="/mapplus-lib/openlayers/v10.6.0-package/dist/ol.js">\x3C/script>')</script>

    <script type="text/javascript">

        var dojoConfig = {
            parseOnLoad: false,
            isDebug: false,
            baseUrl: "",
            async: true,
            packages: [{
                name: "njs",
                location: "/mapplus-lib/mapplus-dojo/v4.0.0/extended"
            }],
            locale: "de"
        };

        var hideLoader = function () {
            dojo.fadeOut({
                node: "preloader",
                onEnd: function () {
                    dojo.style("preloader", "display", "none");
                }
            }).play();
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script>window.Sortable || document.write('<script src="/mapplus-lib/Sortable/1.15.0/Sortable.min.js">\x3C/script>')</script>
    <script
        data-dojo-config="packages:[{name:'dojo',location:'https://cdnjs.cloudflare.com/ajax/libs/dojo/1.17.3'},{name:'dijit',location:'/mapplus-lib/dojo-release/dojo-release-1.17.3/dijit'},{name:'dojox',location:'/mapplus-lib/dojo-release/dojo-release-1.17.3/dojox'}]"
        data-dojo-config="mblAlwaysHideAddressBar: true"
        src="https://cdnjs.cloudflare.com/ajax/libs/dojo/1.17.3/dojo.js"></script>
    <script>window.define || document.write('<script data-dojo-config= \'packages:[{name:"dojo",location:"/mapplus-lib/dojo-release/dojo-release-1.17.3/dojo"},{name:"dijit",location:"/mapplus-lib/dojo-release/dojo-release-1.17.3/dijit"},{name:"dojox",location:"/mapplus-lib/dojo-release/dojo-release-1.17.3/dojox"}],mblAlwaysHideAddressBar:true\' src="/mapplus-lib/dojo-release/dojo-release-1.17.3/dojo/dojo.js">\x3C/script>')</script>

    <link rel="stylesheet" href="public/css/override.css" />
    <script>
        var isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        if ((navigator.userAgent.indexOf("iPad") > -1) || (navigator.platform.indexOf('Mac') > -1)) {
            console.log(navigator.userAgent);
            var ipadCss = document.createElement("link");
            ipadCss.type = "text/css";
            ipadCss.rel = "stylesheet";
            ipadCss.href = "../core/templates/nwow_floating/css/style_ipad.css";
            document.head.appendChild(ipadCss);
        } 
    </script>

</head>

<body class="tundra">
    <!-- Preloader mit Critical Inline CSS für sofortige Anzeige -->
    <style>
      #preloader{position:fixed;top:0;left:0;right:0;bottom:0;width:100%;height:100%;background:rgba(255,255,255,0.95);background-image:none!important;display:flex;align-items:center;justify-content:center;z-index:99999;perspective:200px}
      #preloader .preloader-cube{width:32px;height:32px;position:relative;transform-style:preserve-3d;transform:rotateX(-30deg) rotateY(-30deg);animation:pRotate 1s infinite linear;will-change:transform;backface-visibility:hidden}
      #preloader .preloader-cube .cube-face{position:absolute;width:32px;height:32px;backface-visibility:hidden}
      #preloader .preloader-cube .cube-front{transform:rotateY(0deg) translateZ(16px);background:#f00}
      #preloader .preloader-cube .cube-back{transform:rotateY(180deg) translateZ(16px);background:#8a0000}
      #preloader .preloader-cube .cube-left{transform:rotateY(-90deg) translateZ(16px);background:#8a0000}
      #preloader .preloader-cube .cube-right{transform:rotateY(90deg) translateZ(16px);background:#ffe4e4}
      #preloader .preloader-cube .cube-top{transform:rotateX(90deg) translateZ(16px);background:#f69f9f}
      #preloader .preloader-cube .cube-bottom{transform:rotateX(-90deg) translateZ(16px);background:#8a0000}
      @keyframes pRotate{from{transform:rotateX(-30deg) rotateY(0deg)}to{transform:rotateX(-30deg) rotateY(360deg)}}
    </style>
    <div id="preloader">
      <div class="preloader-cube"><div class="cube-face cube-front"></div><div class="cube-face cube-back"></div><div class="cube-face cube-left"></div><div class="cube-face cube-right"></div><div class="cube-face cube-top"></div><div class="cube-face cube-bottom"></div></div>
    </div>
    <!-- begin modules load: must be done here in body-->

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol-ext/dist/ol-ext.min.css"
        onerror="this.href='mapplus-lib/openlayers/ol-ext/dist/ol-ext.min.css';">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/ol-ext/dist/ol-ext.min.js"></script>
    <script>window.ol.ext || document.write('<script src="/mapplus-lib/openlayers/ol-ext/dist/ol-ext.min.js">\x3C/script>')</script>

    <script type="text/javascript" src="/mapplus-lib/mapplus-dojo/v4.0.0/common.js"></script>
    <script type="text/javascript" src="/mapplus-lib/mapplus-dojo/v4.0.0/njs.js"></script>
    <script type="text/javascript" src="/mapplus-lib/mapplus-dojo/v4.0.0/layout.js"></script>
    <script type="text/javascript" src="/mapplus-lib/mapplus-dojo/v4.0.0/appmanager.js"></script>
    <script type="text/javascript" src="/mapplus-lib/mapplus-dojo/v4.0.0/search.js"></script>
    <!--     <script type="text/javascript" src="/mapplus-lib/mapplus-dojo/v4.0.0/floatingwindow.js"></script>-->
    <script type="text/javascript" src="/mapplus-lib/mapplus-dojo/v4.0.0/provider/OLPlus/openlayers.js"></script>

    <script type="text/javascript">
        /* Application configuration */
        njs.AppManager.Version = "v4.0.0";
        njs.AppManager.apipath = "/mapplus-lib/mapplus-dojo/";
        njs.AppManager.Provider = "OLPlus";
        njs.AppManager.template = "nwow_floating";
        njs.AppManager.keepalivetimeout = 180000; // millisecs
        njs.AppManager.keepalivepage = "/mapplus-lib/mapplus-dojo/v4.0.0/php/sso/keepalive.php"
    </script>
    <?php print $set_vars?>


    <!-- dojo modules and startup config-->
    <script type="text/javascript" src="public/config/modules.js?v=v4.0.0"></script>
    <!-- end modules load -->


    <div id="disclaimer_copyright" class="njsDisclaimer"></div>
    <!-- TYDAC Disclaimer entfernt -->
    <div id="disclaimer_tips" class="njsDisclaimer"></div>
    <div id="disclaimer_news" class="njsDisclaimer"></div>
    <div id="disclaimer_pdf" class="njsDisclaimer" style='visibility:hidden'></div>

    <!-- Modaler Dialog mit iframe - ohne Rahmen, abgedunkelter Hintergrund -->
    <div id="mapsInfoDialog" data-dojo-type="dijit/Dialog" title="">
        <div class="customRefreshBtn" onclick="refreshIframe()" title="Seite neu laden">↻</div>
        <div class="customBackBtn" onclick="goBackInIframe()">‹</div>
        <div class="customCloseBtn" onclick="closeMapsInfoDialog()">×</div>
        <iframe id="mapsInfoFrame" name="mapsInfoFrame" data-src="/maps/tnet/inframe-maps.html" 
            loading="lazy" sandbox="allow-same-origin allow-scripts" referrerpolicy="no-referrer"
            style="width: 100%; height: 100%; border: none;"></iframe>
    </div>

    <!-- Splash Screen - sofort sichtbar -->
    <div id="splash-screen">
        <div id="splash-logo">
            <img src="/maps/tnet/resources/logo_gis.svg" alt="GIS Daten AG">
            <div id="splash-cube">
                <div class="cube-face cube-front"></div>
                <div class="cube-face cube-back"></div>
                <div class="cube-face cube-left"></div>
                <div class="cube-face cube-right"></div>
                <div class="cube-face cube-top"></div>
                <div class="cube-face cube-bottom"></div>
            </div>
        </div>
        <div id="splash-loader">
            <div id="splash-loader-bar"></div>
        </div>
    </div>


    
    <!-- GIS Header-Leiste -->
    <div id="gis_logo_header"></div>
    
    <!-- Header Toolbar rechts oben -->
    <div id="header_toolbar">
        <!-- Anmelde-Button (nicht angemeldet) -->
        <div id="header_login" title="Anmelden" onclick="window.location.href=window.location.href+'&amp;group=?'">
            <span class="login-text">Anmelden</span>
            <svg class="login-arrow" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        </div>
        <!-- Abmelde-Bereich (angemeldet) -->
        <div id="header_logout" style="display: none;" title="Abmelden" onclick="doLogout()">
            <svg class="user-icon" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            <span id="header_username" class="username-text"></span>
            <span class="separator">|</span>
            <span class="logout-text">Abmelden</span>
            <svg class="logout-arrow" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        </div>
        <!-- News (Glocke) -->
        <div class="toolbar-item" title="News" onclick="window.open('https://www.gis-daten.ch/news-termine/news/', '_blank')">
            <svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/></svg>
        </div>
        <!-- Support (Mail) -->
        <div class="toolbar-item" title="Support kontaktieren" onclick="window.open('https://www.gis-daten.ch/ueber-uns/support/', '_blank')">
            <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
        </div>
        <!-- Hamburger Menü -->
        <div id="header_menu" class="toolbar-item" title="Menü" onclick="toggleHeaderMenu()">
            <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
            <!-- Dropdown Menü -->
            <div id="header_menu_dropdown" class="menu-dropdown">
                <div class="menu-item" onclick="event.stopPropagation(); openHelp();">
                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
                    <span>Hilfe</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Kartenauswahl Button links oben -->
    <div id="header_maps_select" onclick="openMapsInfoDialog()" title="Kartenauswahl öffnen">
        <span class="maps-icon"><img src="/maps/tnet/resources/icon-maps.svg" alt=""></span>
        <span class="maps-text">Karten</span>
    </div>
    
    <!-- Suchfeld im Header (fixed positioniert) -->
    <div id="njs_search_wrapper"></div>
    
    <!-- GIS Logo links oben (SVG + drehender Würfel) -->
    <a id="gis_logo_container" href="https://www.gis-daten.ch" target="_blank" title="GIS Daten AG - Nidwalden Obwalden">
        <img class="gis-logo-svg" src="/maps/tnet/resources/logo_gis.svg" alt="GIS Daten AG">
        <img class="gis-logo-cube" src="/maps/tnet/resources/gis-cube.gif" alt="">
    </a>

    <div id="freepane" style="position: absolute;left:20px;top:20px;z-index: 50;width:340px;">
        <!-- <div id="lselector">
            <select id="langselect" onchange="changemappluslang(this.options[this.selectedIndex].value);">
                <option value="de" selected>de</option>
                <option value="en">en</option>
                <option value="fr">fr</option>
                <option value="it">it</option>
            </select>
        </div> -->
        <div id="leftPaneHeader" class="njsFooter">
            <div id="logoMapPlus"></div>
        </div>


        <div id="spring">
            <!-- ÜBERGEORDNETES MENU -->
            <div id="tp_overview_menu" data-dojo-type="dijit/TitlePane"
                data-dojo-props="title: 'Themenkatalog', open:false" style="padding:0px;margin:0px;">

                <!-- LAYERMANAGER MENU - wird per JS zu Tabs konvertiert -->
                <div id="kantons_container">
                    <div id="tp_layer_menu" data-dojo-type="dijit/TitlePane" data-dojo-props="title: 'Nidwalden', open:false"
                        style="padding:0px;margin:0px;">
                        <div id="layer_menu" data-dojo-type="dijit.layout.ContentPane" title="Titel 1">
                            <div id="njs_main_lyrmgr_wrapper" style="width: 100%;">
                            </div>
                        </div>
                    </div>
                    
                    <div id="tp_layer_menu2" data-dojo-type="dijit/TitlePane" data-dojo-props="title: 'Obwalden', open:false"
                        style="padding:0px;margin:0px;">
                        <div id="layer_menu2" data-dojo-type="dijit.layout.ContentPane" title="Titel 2">
                            <div id="njs_second_lyrmgr_wrapper" style="width: 100%;">
                            </div>
                        </div>
                    </div>
                    <div id="tp_layer_menu3" data-dojo-type="dijit/TitlePane" data-dojo-props="title: 'Bund', open:false"
                        style="padding:0px;margin:0px;">
                        <div id="layer_menu3" data-dojo-type="dijit.layout.ContentPane" title="Titel 3">
                            <div id="njs_third_lyrmgr_wrapper" style="width: 100%;">
                            </div>
                        </div>
                    </div>
                    <div id="tp_layer_menu4" data-dojo-type="dijit/TitlePane" data-dojo-props="title: 'Weitere', open:false"
                        style="padding:0px;margin:0px;">
                        <div id="layer_menu4" data-dojo-type="dijit.layout.ContentPane" title="Titel 4">
                            <div id="njs_forth_lyrmgr_wrapper" style="width: 100%;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- LAYERMANAGER WMS -->
            <div id="tp_wms_menu" data-dojo-type="dijit/TitlePane"
                data-dojo-props="title: 'Externe Kartendienste (WMS)', open:false">
                <div id="wms_menu" dojotype="dijit.layout.ContentPane" title="Externe Kartendienste">
                    <div id="njs_wmsimport_dialog" style="width:100%; height:100%;"></div>
                </div>
            </div>
            <!-- LAYERMANAGER SORT LAYERS -->
            <div id="tp_sort_menu" data-dojo-type="dijit/TitlePane"
                data-dojo-props="title: 'Dargestellte Themen', open:false">
                <div id="sort_menu">
                    <div id="njs_main_lyrsorter_wrapper" style="width: 100%; height:100%; border:0">
                        <div id="main_lyrsorter_txt" style="display:block;text-align: center;">--- Keine Daten
                            ausgewählt ---</div>
                        <ul id="main_lyrsorter" style="list-style-type: none; padding: 0;"></ul>
                    </div>
                </div>
            </div>
            <!-- TOOL MENU -->
            <div id="tp_tools_menu" data-dojo-type="dijit/TitlePane"
                data-dojo-props="title: 'Werkzeuge / Export', open:false">
                <div id="tools_menu">
                    <div id="njs_measure_wrapper"></div>
                    <div id="njs_redlining_wrapper"></div>
                </div>
                <div id="preview_menu" data-dojo-type="dijit/TitlePane"
                    data-dojo-props="title: 'Export PDF / PNG', open:true">
                    <span style="width:100%;text-align:center;display:block;">
                        <button id="btn_htmlprint1_preview"
                            class="dijitReset dijitInline dijitButtonNode dijitButtonExport"
                            style="text-align: center;box-shadow: 0px 1px 2px #999;margin-right: 10px !important;height: 24px !important;min-width:97px">
                            <span class="njsIconButtonVorExport"
                                style="width:18px;height:18px;display:inline-block"></span>
                            <span>Export</span>
                        </button>

                    </span>
                </div>
            </div>

            <!-- PRINT MENU -->
            <div id="tp_print_menu" data-dojo-type="dijit/TitlePane" data-dojo-props="title: 'Drucken', open:false">

                <div id="print_menu" data-dojo-type="dijit/TitlePane"
                    data-dojo-props="title: 'Ausdruck massstäblich', open:true">
                    <div id="njs_print_wrapper" style="width: 100%; height:100%; border:0"></div>
                </div>


            </div>

            <!-- OVERVIEW -->
            <div id="tp_ov_menu" data-dojo-type="dijit/TitlePane" data-dojo-props="title: 'Navigieren', open:false">
                <div id="ovWin"
                    style="border:solid 1px #424A52; display:block; position:relative; right:-1px; bottom:-1px; z-Index:998; width:310px;height:240px;">
                </div>
            </div>

            <!-- FooterPane for coords - versteckt -->
            <div id="footPane_main" class="edgePanel" data-dojo-type="dijit.layout.ContentPane"
                data-dojo-props="region: 'bottom'" style="display:none;">
                <div id="footPane" class="edgePanel" data-dojo-type="dijit.layout.ContentPane"
                    data-dojo-props="region: 'bottom'">
                    <div id="leftPaneFooter" class="njsFooter">
                        <div id="njs_coordinates_wrapper"></div>
                    </div>
                </div>
            </div>
            
            <!-- Panel Zuklapp-Button -->
            <div class="close_switch" title="Panel ein-/ausklappen" onclick="document.getElementById('freepane').classList.toggle('close');"></div>
        </div>

        <!-- Scroll-to-Top Button (Chevron wird via CSS generiert) -->
        <button id="scrollToTopBtn" onclick="scrollSpringToTop()" title="Nach oben"></button>

    </div>





    <div id="NeapoljsContainer" dojotype="dijit.layout.BorderContainer" design="headline" gutters="false"
        style="width:100%; height:100%;">


        <div id="centerPane" class="edgePanel" data-dojo-type="dijit.layout.ContentPane"
            data-dojo-props="region: 'center'">
            <div id="centerPaneLayout" class="demoLayout" data-dojo-type="dijit.layout.BorderContainer"
                data-dojo-props="design: 'headline'" style="margin: 0px;padding: 0px;border: none">
                <div dojotype="dijit.layout.ContentPane" id='mapContainer' region="center" style="overflow:hidden;">
                    <div id="popup" class="ol-popup">
                        <a href="#" id="popup-closer" class="ol-popup-closer"></a>
                        <div id="popup-content"></div>
                    </div>

                    <div id="njs_main_shop_wrapper" style="display:none"></div>
                    <div id="map" class="map-cont" style="height:100%;"></div>
                    
                    <!-- Rechtsklick-Kontextmenü -->
                    <div id="map-context-menu" class="context-menu">
                        <div class="context-menu-header">
                            <span id="ctx-coords-display">--</span>
                        </div>
                        <div class="context-menu-item" onclick="ctxCopyCoords('lv95')">
                            <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                            <span>Koordinaten kopieren (LV95)</span>
                        </div>
                        <div class="context-menu-item" onclick="ctxCopyCoords('wgs84')">
                            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                            <span>Koordinaten kopieren (WGS84)</span>
                        </div>
                        <div class="context-menu-item" onclick="ctxFixCoords()">
                            <svg viewBox="0 0 24 24"><path d="M17 4h-3V2h-4v2H7c-1.1 0-2 .9-2 2v15c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 17H7V6h10v15z"/><path d="M8 10h8v2H8zm0 4h8v2H8z"/></svg>
                            <span>Koordinaten fixieren</span>
                        </div>
                        <div class="context-menu-divider"></div>
                        <div class="context-menu-item" onclick="ctxWhatIsHere()">
                            <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                            <span>Was ist hier?</span>
                        </div>
                        <div class="context-menu-item" onclick="ctxZoomHere()">
                            <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14zm.5-7H9v2H7v1h2v2h1v-2h2V9h-2z"/></svg>
                            <span>Hierher zoomen</span>
                        </div>
                        <div class="context-menu-item" onclick="ctxSetMarker()">
                            <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/></svg>
                            <span>Marker setzen</span>
                        </div>
                        <div class="context-menu-divider"></div>
                        <div class="context-menu-item" onclick="ctxRouteFrom()">
                            <svg viewBox="0 0 24 24"><path d="M2 12l5 5v-4h9v6l7-7-7-7v6H7V7z"/></svg>
                            <span>Route von hier</span>
                        </div>
                        <div class="context-menu-item" onclick="ctxRouteTo()">
                            <svg viewBox="0 0 24 24"><path d="M22 12l-5-5v4H8V5l-7 7 7 7v-6h9v4z"/></svg>
                            <span>Route hierher</span>
                        </div>
                        <div class="context-menu-divider"></div>
                        <div class="context-menu-item" onclick="ctxOpenGoogleMaps()">
                            <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                            <span>In Google Maps öffnen</span>
                        </div>
                        <div class="context-menu-item" onclick="ctxOpenStreetView()">
                            <svg viewBox="0 0 24 24"><path d="M12.56 14.33c-.34.27-.56.7-.56 1.17V21h7c1.1 0 2-.9 2-2v-5.98c-.94-.33-1.95-.52-3-.52-2.03 0-3.93.7-5.44 1.83zM12 6c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10h1v-6.5c0-.91.47-1.71 1.19-2.17C15.27 12.54 16.6 12 18 12c1.34 0 2.61.29 3.76.8.16-.59.24-1.21.24-1.8 0-5.52-4.48-10-10-10z"/></svg>
                            <span>StreetView öffnen</span>
                        </div>
                        <div class="context-menu-divider"></div>
                        <div class="context-menu-item" onclick="ctxCopyLink()">
                            <svg viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg>
                            <span>Link zu Position kopieren</span>
                        </div>
                    </div>
                    
                    <div id="mainButtonBar"></div>
                    
                    <!-- Map Footer Bar - Durchgehende Leiste unten -->
                    <div id="map-footer-bar">
                        <div class="map-footer-left">
                            <div class="map-footer-scale">
                                <select id="map-scale-select" onchange="setMapScale(this.value)" title="Maßstab wählen">
                                    <option value="100">1:100</option>
                                    <option value="250">1:250</option>
                                    <option value="500">1:500</option>
                                    <option value="1000">1:1'000</option>
                                    <option value="2500">1:2'500</option>
                                    <option value="5000">1:5'000</option>
                                    <option value="10000">1:10'000</option>
                                    <option value="25000" selected>1:25'000</option>
                                    <option value="50000">1:50'000</option>
                                    <option value="100000">1:100'000</option>
                                    <option value="200000">1:200'000</option>
                                    <option value="500000">1:500'000</option>
                                    <option value="1000000">1:1'000'000</option>
                                </select>
                            </div>
                            <div class="map-footer-scalebar">
                                <div id="scale-line"></div>
                            </div>
                        </div>
                        <div class="map-footer-center">
                            <div class="map-footer-item map-coord-system">
                                <select id="map-coord-switch" onchange="switchCoordSystem(this.value)">
                                    <option value="lv95">CH1903+ / LV95</option>
                                    <option value="wgs84">WGS84</option>
                                </select>
                            </div>
                            <div class="map-footer-item">
                                <span class="map-footer-label">Koordinaten (m)</span>
                                <span id="map-coord-display" class="map-footer-value">--</span>
                            </div>
                            <div class="map-footer-item" title="Höhe 1: Geländehöhe&#10;Höhe 2: Oberflächenhöhe&#10;Höhe 3: Objekthöhe">
                                <span class="map-footer-label">Höhe:</span>
                                <span id="map-coord-altitude" class="map-footer-value">--</span>
                            </div>
                            <div class="map-footer-item map-footer-picker" id="map-coord-picker-btn" onclick="toggleCoordPicker()" title="Koordinaten fixieren">
                                <svg viewBox="0 0 24 24" width="14" height="14"><path fill="currentColor" d="M16,12V4H17V2H7V4H8V12L6,14V16H11.2V22H12.8V16H18V14L16,12Z"/></svg>
                            </div>
                        </div>
                        <div class="map-footer-right">
                            <span id="map-footer-copyright">© LK / Swissimage: swisstopo, Übrige Daten GIS Daten AG</span>
                        </div>
                    </div>
                    
                    <div id='mapcontrols_div' style="z-index:99999;">
                        <div id='toggle_coltool1_div' style="visibility: hidden;">
                            <input type="button" class="toggle_coltool" id="btnBW"
                                onclick="njs.AppManager.toggleBaseLayerColor('main','toggle_coltool1',this);">
                        </div>
                        <div style="width: 3px;"></div>
                        <div id='opacitytool1_rangediv' style="height:20px; visibility: hidden; width: 110px;">
                            <input type='range' min='0' max='100' value='0'
                                style="width: 110px; margin-top: -1px !important;" id='opacitytool1_range'
                                oninput="njs.AppManager.setBaseLayerOpacity('main',this.value);"
                                onchange="njs.AppManager.setBaseLayerOpacity('main',this.value);">
                        </div>
                    </div>
                    <!-- <div id="ovWin" style="border:solid 1px #424A52; display:none; position:absolute; right:-1px; bottom:-1px; z-Index:998; width:240px;height:240px;">
                        <div id="overviewDiv" style="width:100%;height:100%;"></div>
                    </div>
                    <div id="ovToggleImg" onClick="njs.Layout.toggle_visibility('ovWin');njs.Layout.toggle_img('ovImg','../core/templates/nwow_floating/img/arrow_tl.png','../core/templates/nwow_floating/img/arrow_br.png')">
                        <img id="ovImg" src="../core/templates/nwow_floating/img/arrow_tl.png" />
                    </div> -->

                    <div id="paneSwitcher" class="edgePanel"
                        style="position: absolute;left: 0px;top: 0px;display: none"></div>

                    <!-- Basemap Selector rechts unten -->
                    <div id="basemap_selector" title="Hintergrundkarte wählen" onclick="toggleBasemapWidget()">
                        <div class="basemap-preview"></div>
                        <span class="basemap-label">Hintergrund</span>
                    </div>

                    <!-- Basemap Widget -->
                    <div id="basemap_widget" class="basemap-widget-hidden">
                        <div class="basemap-widget-header">
                            <span>GRUNDKARTE</span>
                            <button class="basemap-widget-close" onclick="toggleBasemapWidget()">&times;</button>
                        </div>
                        <div class="basemap-widget-content">
                            <!-- Layer Toggles -->
                            <div class="basemap-layer-section">
                                <div class="basemap-layer-row">
                                    <span class="layer-icon">〰</span>
                                    <span class="layer-label">Höhenkurven</span>
                                    <div class="layer-toggle">
                                        <button class="toggle-btn active" data-layer="hoehenkurven" data-value="on">EIN</button>
                                        <button class="toggle-btn" data-layer="hoehenkurven" data-value="off">AUS</button>
                                    </div>
                                </div>
                                <div class="basemap-layer-row">
                                    <span class="layer-icon">⊞</span>
                                    <span class="layer-label">Projektebene</span>
                                    <div class="layer-toggle">
                                        <button class="toggle-btn" data-layer="projektebene" data-value="on">EIN</button>
                                        <button class="toggle-btn active" data-layer="projektebene" data-value="off">AUS</button>
                                    </div>
                                </div>
                                <div class="basemap-layer-row">
                                    <span class="layer-icon">◯</span>
                                    <span class="layer-label">Gemeindegrenzen</span>
                                    <div class="layer-toggle">
                                        <button class="toggle-btn active" data-layer="gemeindegrenzen" data-value="on">EIN</button>
                                        <button class="toggle-btn" data-layer="gemeindegrenzen" data-value="off">AUS</button>
                                    </div>
                                </div>
                                <div class="basemap-layer-row">
                                    <span class="layer-icon">◧</span>
                                    <span class="layer-label">Farbig / Grau</span>
                                    <div class="layer-toggle">
                                        <button class="toggle-btn active" data-layer="farbmodus" data-value="color" 
                                            onclick="njs.AppManager.toggleBaseLayerColor('main','toggle_coltool1',this); this.classList.add('active'); this.nextElementSibling.classList.remove('active');">FARBE</button>
                                        <button class="toggle-btn" data-layer="farbmodus" data-value="grey"
                                            onclick="njs.AppManager.toggleBaseLayerColor('main','toggle_coltool1',this); this.classList.add('active'); this.previousElementSibling.classList.remove('active');">GRAU</button>
                                    </div>
                                </div>
                                <div class="basemap-layer-row">
                                    <span class="layer-label">Transparenz</span>
                                    <input type="range" class="transparency-slider" min="0" max="100" value="0" 
                                        oninput="njs.AppManager.setBaseLayerOpacity('main',this.value); this.nextElementSibling.textContent=this.value;" 
                                        onchange="njs.AppManager.setBaseLayerOpacity('main',this.value);">
                                    <span class="transparency-value">0</span>
                                </div>
                            </div>

                            <!-- Haupt-Basemaps (immer sichtbar) -->
                            <div class="basemap-cards-main">
                                <div class="basemap-card active" data-basemap="swissimage" onclick="njs.AppManager.Maps['main'].changeBaseMap('swissimage');">
                                    <div class="basemap-card-preview orthofoto"></div>
                                    <span class="basemap-card-label">Orthofoto</span>
                                </div>
                                <div class="basemap-card" data-basemap="av_sw" onclick="njs.AppManager.Maps['main'].changeBaseMap('av_sw');">
                                    <div class="basemap-card-preview basisplan"></div>
                                    <span class="basemap-card-label">Basisplan</span>
                                </div>
                                <div class="basemap-card" data-basemap="plan_fuer_grundbuch_bund" onclick="njs.AppManager.Maps['main'].changeBaseMap('plan_fuer_grundbuch_bund');">
                                    <div class="basemap-card-preview grundbuch"></div>
                                    <span class="basemap-card-label">Plan f. Grundbuch</span>
                                </div>
                            </div>

                            <!-- Erweiterte Basemap Auswahl -->
                            <div class="basemap-expand-header">
                                <span class="expand-icon">▶</span> erweitern
                            </div>
                            <div class="basemap-cards">
                                <div class="basemap-card" data-basemap="pk_color" onclick="njs.AppManager.Maps['main'].changeBaseMap('pk_color');">
                                    <div class="basemap-card-preview landeskarte"></div>
                                    <span class="basemap-card-label">Landeskarte</span>
                                </div>
                                <div class="basemap-card" data-basemap="siegfried" onclick="njs.AppManager.Maps['main'].changeBaseMap('siegfried');">
                                    <div class="basemap-card-preview siegfried"></div>
                                    <span class="basemap-card-label">Siegfriedkarten</span>
                                </div>
                                <div class="basemap-card" data-basemap="none" onclick="njs.AppManager.Maps['main'].changeBaseMap('none');">
                                    <div class="basemap-card-preview transparent"></div>
                                    <span class="basemap-card-label">Transparent</span>
                                </div>
                                <div class="basemap-card" data-basemap="leer" onclick="njs.AppManager.Maps['main'].changeBaseMap('leer');">
                                    <div class="basemap-card-preview keine"></div>
                                    <span class="basemap-card-label">Leer</span>
                                </div>
                                <div class="basemap-card" data-basemap="av_color" onclick="njs.AppManager.Maps['main'].changeBaseMap('av_color');">
                                    <div class="basemap-card-preview av-color"></div>
                                    <span class="basemap-card-label">Basisplan farbig</span>
                                </div>
                                <div class="basemap-card" data-basemap="osm" onclick="njs.AppManager.Maps['main'].changeBaseMap('osm');">
                                    <div class="basemap-card-preview osm"></div>
                                    <span class="basemap-card-label">OpenStreetMap</span>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <!-- /map container -->


                <div dojotype="dijit.layout.ContentPane" id='custompaneContainer' class="outer"
                    style="width:440px; -webkit-overflow-scrolling:touch !important; margin: 0px;padding: 0px;border: none;"
                    data-dojo-props="region: 'right', splitter: true">
                    <iframe id="custompaneFrame" src="" height="100%"
                        style="-webkit-overflow-scrolling:touch !important; border:none; width:100%; height:100%;">
                    </iframe>
                    <iframe id="custompaneFrameForm" src="" height="100%"
                        style="-webkit-overflow-scrolling:touch !important;display:none; border:none; width:100%; height:100%;">
                    </iframe>
                    <!-- divert maptips in this area -->
                    <!-- <div id="custompaneDiv"></div> -->
                </div>
                <div dojotype="dijit.layout.ContentPane" id='streetviewContainer' class="outer"
                    style="width:500px; display:none; -webkit-overflow-scrolling:touch !important; margin: 0px;padding: 0px;border: none;"
                    data-dojo-props="region: 'right', splitter: true">
                    <iframe id="streetviewFrame" src="" height="100%"
                        style="border:0px; width:100%; height:calc(100%+1px);">
                    </iframe>
                </div>
            </div>
            <!-- /centerPaneLayout-->
        </div>
        <!-- /centerPane-->
        <!-- End EdgePannel -->
    </div>
    <!-- /NeapoljsContainer -->

    <!-- TNET------------------------->
    <!-- TNET helpers for bookmarks&Co. -->
    <script type="text/javascript" src="/maps/tnet/tnet-mapplus-helpers.js"></script>
    
    <!-- TNET Accordion/Tab-Konverter -->
    <link rel="stylesheet" href="/maps/tnet/tnet_toc.css" />
    <script type="text/javascript" src="/maps/tnet/tnet_toc.js"></script>

    <!-- Panel-Schatten dynamisch positioniert -->
    <script type="text/javascript">
        (function() {
            function initPanelShadow() {
                var freepane = document.getElementById('freepane');
                var closeSwitch = document.querySelector('.close_switch');
                if (!freepane || !closeSwitch) {
                    setTimeout(initPanelShadow, 200);
                    return;
                }
                
                // Schatten-Element erstellen
                var shadow = document.createElement('div');
                shadow.id = 'panelShadow';
                freepane.parentNode.insertBefore(shadow, freepane.nextSibling);
                
                function updateShadow() {
                    var rect = closeSwitch.getBoundingClientRect();
                    var headerTop = 69;
                    var bottom = rect.bottom;
                    var width = rect.width;
                    
                    shadow.style.top = headerTop + 'px';
                    shadow.style.height = (bottom - headerTop) + 'px';
                    shadow.style.width = width + 'px';
                    
                    // Bei geschlossenem Panel: Breite der minimierten Leiste
                    if (freepane.classList.contains('close')) {
                        shadow.style.width = '170px';
                        shadow.style.left = ((340 - 170) / 2) + 'px';
                        shadow.style.borderRadius = '0 0 4px 4px';
                    } else {
                        shadow.style.left = '0px';
                        shadow.style.borderRadius = '0 0 4px 4px';
                    }
                }
                
                // Kontinuierliche Animation mit requestAnimationFrame
                function animateLoop() {
                    updateShadow();
                    requestAnimationFrame(animateLoop);
                }
                animateLoop();
                
                window.addEventListener('resize', updateShadow);
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initPanelShadow);
            } else {
                initPanelShadow();
            }
        })();
    </script>

    <!-- Scroll-to-Top Button Logic -->
    <script type="text/javascript">
        // Scroll-to-Top Funktionalität für #spring
        function scrollSpringToTop() {
            var spring = document.getElementById('spring');
            if (spring) {
                spring.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        // Button ein-/ausblenden basierend auf Scroll-Position
        (function() {
            function initScrollToTop() {
                var spring = document.getElementById('spring');
                var btn = document.getElementById('scrollToTopBtn');
                if (!spring || !btn) {
                    setTimeout(initScrollToTop, 500);
                    return;
                }
                
                spring.addEventListener('scroll', function() {
                    if (spring.scrollTop > 100) {
                        btn.classList.add('visible');
                    } else {
                        btn.classList.remove('visible');
                    }
                });
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initScrollToTop);
            } else {
                initScrollToTop();
            }
        })();
    </script>

    <script type="text/javascript">
        // Auto-Start für Bookmark-URLs direkt vor </body>
        (function() {
            console.log('Auto-Start Script geladen');
            
            function startBookmarkFromUrl() {
                var currentPath = window.location.pathname;
                console.log('Prüfe URL:', currentPath);
                
                var match = currentPath.match(/\/maps\/([^\/]+)$/);
                
                if (match && match[1]) {
                    var bookmarkId = match[1];
                    console.log('Bookmark in URL gefunden:', bookmarkId);
                    
                    // Prüfe ob alle benötigten Funktionen verfügbar sind
                    if (typeof window.TnetSetBookmark === 'function' &&
                        window.njs && window.njs.AppManager && 
                        window.njs.AppManager.setMapBookmark &&
                        typeof window.njs.AppManager.infoFloatWinRemoveallItems === 'function') {
                        console.log('Alle Funktionen verfügbar - rufe TnetSetBookmark auf');
                        window.TnetSetBookmark(bookmarkId);
                    } else {
                        console.log('Warte auf vollständiges Laden... (njs.AppManager.infoFloatWinRemoveallItems)');
                        setTimeout(startBookmarkFromUrl, 1500);
                    }
                } else {
                    console.log('Keine Bookmark-ID in URL');
                }
            }
            
            // Starte nach 2 Sekunden
            setTimeout(startBookmarkFromUrl, 4000);
        })();
    </script>

    <script type="text/javascript">
        // Funktionen auf window machen damit sie global erreichbar sind
        var iframeHistory = [];
        var iframeHistoryIndex = -1;
        
        window.setupIframeMonitoring = function() {
            var iframe = document.getElementById("mapsInfoFrame");
            if (iframe) {
                iframe.addEventListener('load', function() {
                    try {
                        var currentUrl = iframe.contentWindow.location.href;
                        if (iframeHistoryIndex === -1 || iframeHistory[iframeHistoryIndex] !== currentUrl) {
                            iframeHistory = iframeHistory.slice(0, iframeHistoryIndex + 1);
                            iframeHistory.push(currentUrl);
                            iframeHistoryIndex = iframeHistory.length - 1;
                        }
                    } catch(e) {
                        console.log("Iframe URL nicht zugänglich (cross-origin)");
                    }
                });
            }
        };
        
        window.openMapsInfoDialog = function() {
            var dialog = dijit.byId("mapsInfoDialog");
            if (dialog) {
                // Toggle: Wenn Dialog offen ist, schliessen
                if (dialog.open) {
                    window.closeMapsInfoDialog();
                    return;
                }
                dialog.show();
                var iframe = document.getElementById("mapsInfoFrame");
                if (iframe) {
                    var lazySrc = iframe.getAttribute('data-src') || '/maps/tnet/inframe-maps.html';
                    if (!iframe.getAttribute('src')) {
                        iframe.src = lazySrc;
                    }
                }
                window.setupIframeMonitoring();
            }
        };
        
        window.closeMapsInfoDialog = function() {
            var dialog = dijit.byId("mapsInfoDialog");
            if (dialog) {
                dialog.hide();
                iframeHistory = [];
                iframeHistoryIndex = -1;
                var iframe = document.getElementById("mapsInfoFrame");
                if (iframe) {
                    // iframe entladen, um Ressourcen freizugeben
                    iframe.removeAttribute('src');
                }
            }
        };
        
        window.goBackInIframe = function() {
            var iframe = document.getElementById("mapsInfoFrame");
            if (!iframe) return;
            
            try {
                iframe.contentWindow.history.back();
            } catch(e) {
                if (iframeHistoryIndex > 0) {
                    iframeHistoryIndex--;
                    iframe.src = iframeHistory[iframeHistoryIndex];
                } else {
                    console.log("Keine vorherige Seite in der History");
                }
            }
        };
        
        window.refreshIframe = function() {
            var iframe = document.getElementById("mapsInfoFrame");
            if (!iframe) return;
            var baseSrc = iframe.getAttribute('data-src') || '/maps/tnet/inframe-maps.html';
            if (!iframe.getAttribute('src')) {
                iframe.src = baseSrc;
            } else {
                var newSrc = baseSrc + (baseSrc.indexOf('?') === -1 ? '?t=' : '&t=') + Date.now();
                iframe.src = newSrc;
            }
        };

        // Basemap Widget Toggle - Kachel wächst zum Widget
        window.toggleBasemapWidget = function() {
            var widget = document.getElementById('basemap_widget');
            var selector = document.getElementById('basemap_selector');
            if (widget && selector) {
                widget.classList.toggle('basemap-widget-hidden');
                selector.classList.toggle('hidden');
            }
        };

        // Login/Logout Status prüfen und anzeigen
        window.updateLoginStatus = function() {
            var loginBtn = document.getElementById('header_login');
            var logoutSection = document.getElementById('header_logout');
            var usernameEl = document.getElementById('header_username');
            
            // Prüfe ob njs.AppManager und auth_user verfügbar
            if (window.njs && njs.AppManager && njs.AppManager.auth_user && njs.AppManager.auth_user !== '') {
                var username = njs.AppManager.auth_user;
                // Angemeldet
                if (loginBtn) loginBtn.style.display = 'none';
                if (logoutSection) logoutSection.style.display = 'flex';
                if (usernameEl) usernameEl.textContent = username;
            } else {
                // Nicht angemeldet
                if (loginBtn) loginBtn.style.display = 'flex';
                if (logoutSection) logoutSection.style.display = 'none';
            }
        };

        // Logout-Funktion
        window.doLogout = function() {
            // Direkte Navigation zur logout.php
            window.location.href = 'logout.php';
        };

        // Hamburger Menü Toggle
        window.toggleHeaderMenu = function() {
            var menu = document.getElementById('header_menu');
            if (menu) {
                menu.classList.toggle('open');
            }
        };

        // Hilfe öffnen
        window.openHelp = function() {
            toggleHeaderMenu(); // Menü schließen
            if (window.njs && njs.AppManager && njs.AppManager.toggleCustomPaneContent) {
                njs.AppManager.toggleCustomPaneContent('help', 'custompane', './core/help/help_de.htm', '', '');
            }
        };

        // Menü schließen bei Klick außerhalb
        document.addEventListener('click', function(e) {
            var menu = document.getElementById('header_menu');
            if (menu && menu.classList.contains('open') && !menu.contains(e.target)) {
                menu.classList.remove('open');
            }
        });

        // Splash Screen ausblenden wenn App bereit
        window.hideSplashScreen = function() {
            var splash = document.getElementById('splash-screen');
            // Anderen Preloader verstecken
            var preloader = document.getElementById('preloader');
            if (preloader) preloader.style.display = 'none';
            
            // streetviewContainer sicher verstecken
            var streetview = document.getElementById('streetviewContainer');
            if (streetview) streetview.style.display = 'none';
            
            if (splash) {
                splash.classList.add('hidden');
                // Nach Animation entfernen
                setTimeout(function() {
                    splash.remove();
                }, 1000);
            }
        };

        // Login-Status beim Laden prüfen und Splash ausblenden
        (function checkAppReady() {
            if (window.njs && njs.AppManager && njs.AppManager.Maps && njs.AppManager.Maps['main']) {
                updateLoginStatus();
                // App ist bereit - Splash ausblenden
                hideSplashScreen();
            } else {
                setTimeout(checkAppReady, 300);
            }
        })();

        // Basemap Widget Interaktion
        document.addEventListener('DOMContentLoaded', function() {
            // Toggle Buttons
            document.querySelectorAll('.layer-toggle .toggle-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var parent = this.closest('.layer-toggle');
                    parent.querySelectorAll('.toggle-btn').forEach(function(b) {
                        b.classList.remove('active');
                    });
                    this.classList.add('active');
                    // TODO: Hier Layer ein/ausschalten
                    console.log('Layer:', this.dataset.layer, 'Value:', this.dataset.value);
                });
            });

            // Basemap Cards - Aktiv-Status setzen
            document.querySelectorAll('.basemap-card').forEach(function(card) {
                card.addEventListener('click', function() {
                    // Alle Cards deaktivieren (auch in main und expanded)
                    document.querySelectorAll('.basemap-card').forEach(function(c) {
                        c.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });

            // Expand Header
            var expandHeader = document.querySelector('.basemap-expand-header');
            if (expandHeader) {
                expandHeader.addEventListener('click', function() {
                    var cards = document.querySelector('.basemap-cards');
                    var icon = this.querySelector('.expand-icon');
                    if (cards) {
                        cards.classList.toggle('expanded');
                        icon.textContent = cards.classList.contains('expanded') ? '▼' : '▶';
                    }
                });
            }
        });

        // FloatingPane (Maptips Dialog) unter Header positionieren
        (function() {
            var headerHeight = 69;
            var minTop = 80;
            
            function adjustPanePosition(pane) {
                if (!pane) return;
                var top = parseInt(pane.style.top) || 0;
                if (top < headerHeight) {
                    pane.style.top = minTop + 'px';
                }
            }
            
            // Observer für das ganze Dokument - fängt neue Elemente ab
            var bodyObserver = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === 1 && node.classList && 
                                node.classList.contains('dojoxFloatingPane')) {
                                adjustPanePosition(node);
                                // Observer für Style-Änderungen auf diesem Pane
                                var styleObserver = new MutationObserver(function() {
                                    adjustPanePosition(node);
                                });
                                styleObserver.observe(node, { attributes: true, attributeFilter: ['style'] });
                            }
                        });
                    }
                });
            });
            bodyObserver.observe(document.body, { childList: true, subtree: true });
            
            // Bestehende Panes auch behandeln
            document.querySelectorAll('.dojoxFloatingPane').forEach(function(pane) {
                adjustPanePosition(pane);
                var styleObserver = new MutationObserver(function() {
                    adjustPanePosition(pane);
                });
                styleObserver.observe(pane, { attributes: true, attributeFilter: ['style'] });
            });
        })();

        // Preload des iFrames bei erster Nutzerinteraktion
        (function(){
            var preloaded = false;
            function preloadMapsInfoIframe(){
                if (preloaded) return;
                var iframe = document.getElementById('mapsInfoFrame');
                if (!iframe) return;
                var lazySrc = iframe.getAttribute('data-src') || '/maps/tnet/inframe-maps.html';
                if (!iframe.getAttribute('src')) {
                    iframe.src = lazySrc;
                }
                preloaded = true;
            }
            var opts = { once: true, passive: true };
            document.addEventListener('pointerdown', preloadMapsInfoIframe, opts);
            document.addEventListener('keydown', preloadMapsInfoIframe, opts);
            document.addEventListener('touchstart', preloadMapsInfoIframe, opts);
            document.addEventListener('mouseover', preloadMapsInfoIframe, opts);
        })();

        // ===== KOORDINATEN-LEISTE AUF DER KARTE =====
        (function() {
            console.log('Footer Bar Script gestartet');
            var currentCoordSystem = 'lv95';
            
            // Koordinaten-System umschalten
            window.switchCoordSystem = function(system) {
                currentCoordSystem = system;
                updateCoordDisplay();
            };
            
            // Picker toggle (Koordinaten fixieren)
            // Wenn aktiv = Koordinaten sind FIXIERT (laufen nicht mit)
            // Wenn inaktiv = Koordinaten laufen mit Mauszeiger
            window.toggleCoordPicker = function() {
                var btn = document.getElementById('map-coord-picker-btn');
                
                // Original CoordDisplay Picker aufrufen
                if (njs && njs.AppManager && njs.AppManager.Tools && 
                    njs.AppManager.Tools.CoordDisplay && 
                    njs.AppManager.Tools.CoordDisplay['map'] && 
                    njs.AppManager.Tools.CoordDisplay['map']['coord2']) {
                    njs.AppManager.Tools.CoordDisplay['map']['coord2'].togglePicker('map');
                }
                
                // Button-Status aus dem Original-Picker synchronisieren
                setTimeout(function() {
                    var pickerBtn = document.getElementById('coord2_picker');
                    if (pickerBtn && btn) {
                        // Wenn original Picker "Checked" hat, ist er aktiv (fixiert)
                        if (pickerBtn.classList.contains('njsIconButtonCoordPickerChecked')) {
                            btn.classList.add('active');
                        } else {
                            btn.classList.remove('active');
                        }
                    }
                }, 50);
            };
            
            // Initialen Status synchronisieren
            function syncPickerStatus() {
                var btn = document.getElementById('map-coord-picker-btn');
                var pickerBtn = document.getElementById('coord2_picker');
                if (pickerBtn && btn) {
                    if (pickerBtn.classList.contains('njsIconButtonCoordPickerChecked')) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                }
            }
            
            // Koordinaten-Anzeige aktualisieren
            function updateCoordDisplay() {
                var coordDisplay = document.getElementById('map-coord-display');
                var lv95Input = document.getElementById('xy_coord2');
                var wgs84Input = document.getElementById('xy_coord3');
                
                if (!coordDisplay) return;
                
                if (currentCoordSystem === 'lv95' && lv95Input) {
                    coordDisplay.textContent = lv95Input.value || '--';
                } else if (currentCoordSystem === 'wgs84' && wgs84Input) {
                    coordDisplay.textContent = wgs84Input.value || '--';
                }
            }
            
            // Höhen-Anzeige aktualisieren
            function updateAltitudeDisplay() {
                var altDisplay = document.getElementById('map-coord-altitude');
                var altInput = document.getElementById('z_alti1');
                
                if (altDisplay && altInput) {
                    var val = altInput.value;
                    if (val) {
                        // Entferne m.ü.M und andere Texte, behalte nur Zahlen und | 
                        val = val.replace(/m\.?ü\.?M\.?/gi, '').trim();
                    }
                    altDisplay.textContent = val ? val : '--';
                }
            }
            
            // Observer für Änderungen an den Original-Inputs
            function setupObservers() {
                console.log('Footer Bar: setupObservers aufgerufen');
                
                // Debug: Was ist verfügbar?
                console.log('njs:', typeof njs);
                if (njs) {
                    console.log('njs.AppManager:', typeof njs.AppManager);
                    if (njs.AppManager) {
                        console.log('njs.AppManager.Maps:', njs.AppManager.Maps);
                        if (njs.AppManager.Maps && njs.AppManager.Maps['main']) {
                            console.log('Maps[main]:', njs.AppManager.Maps['main']);
                            console.log('Maps[main].map:', njs.AppManager.Maps['main'].map);
                            console.log('Maps[main] keys:', Object.keys(njs.AppManager.Maps['main']));
                        }
                    }
                }
                
                var lv95Input = document.getElementById('xy_coord2');
                var wgs84Input = document.getElementById('xy_coord3');
                var altInput = document.getElementById('z_alti1');
                
                // Warte auf Map statt auf Inputs
                if (!njs || !njs.AppManager || !njs.AppManager.Maps || !njs.AppManager.Maps['main'] || !njs.AppManager.Maps['main'].mapObj) {
                    // Map noch nicht da, später nochmal versuchen
                    console.log('Footer Bar: Map noch nicht bereit, warte 500ms...');
                    setTimeout(setupObservers, 500);
                    return;
                }
                
                console.log('Footer Bar: Map gefunden!');
                var map = njs.AppManager.Maps['main'].mapObj;
                var view = map.getView();
                console.log('Footer Bar: View:', view);
                
                // Initialen Picker-Status synchronisieren
                syncPickerStatus();
                
                // Initiales Update
                updateScaleDisplay();
                updateCopyrightDisplay();
                
                // Event-Listener für Zoom/Resolution-Änderungen
                view.on('change:resolution', updateScaleDisplay);
                
                // Auch bei Bewegung aktualisieren (für den Fall)
                map.on('moveend', updateScaleDisplay);
                
                console.log('Map Footer Bar: Scale Listener registriert auf View', view);
                
                // Polling für Koordinaten und andere Updates (nur wenn Picker nicht fixiert)
                setInterval(function() {
                    updateCoordDisplay();
                    updateAltitudeDisplay();
                    syncPickerStatus();
                }, 500);
                
                console.log('Map Footer Bar: Initialisiert');
            }
            
            // Maßstab berechnen (korrekt mit Projektion)
            function getMapScale(map) {
                var view = map.getView();
                var resolution = view.getResolution();
                var projection = view.getProjection();
                
                if (!resolution || !projection) return null;
                
                // Meter pro Pixel unter Berücksichtigung der Projektion
                var metersPerPixel = resolution * projection.getMetersPerUnit();
                
                // DPI-Konstante (96 dpi): 1 inch = 0.0254 m
                var DPI = 96;
                var inchesPerMeter = 39.37;
                
                // Maßstab 1 : N
                var scale = metersPerPixel * inchesPerMeter * DPI;
                return Math.round(scale);
            }
            
            // Vordefinierte Maßstäbe für die Auswahl
            var predefinedScales = [100, 250, 500, 1000, 2500, 5000, 10000, 25000, 50000, 100000, 200000, 500000, 1000000];
            
            // Resolution aus Maßstab berechnen (umgekehrte Formel)
            function getResolutionFromScale(scale) {
                if (!njs || !njs.AppManager || !njs.AppManager.Maps || !njs.AppManager.Maps['main'] || !njs.AppManager.Maps['main'].mapObj) return null;
                var map = njs.AppManager.Maps['main'].mapObj;
                var view = map.getView();
                var projection = view.getProjection();
                
                var DPI = 96;
                var inchesPerMeter = 39.37;
                var metersPerUnit = projection.getMetersPerUnit();
                
                // scale = resolution * metersPerUnit * inchesPerMeter * DPI
                // resolution = scale / (metersPerUnit * inchesPerMeter * DPI)
                var resolution = scale / (metersPerUnit * inchesPerMeter * DPI);
                return resolution;
            }
            
            // Maßstab setzen (Zoom ändern)
            window.setMapScale = function(scaleValue) {
                var scale = parseInt(scaleValue);
                if (!scale) return;
                
                var resolution = getResolutionFromScale(scale);
                if (!resolution) return;
                
                var map = njs.AppManager.Maps['main'].mapObj;
                var view = map.getView();
                
                // Sanft zum neuen Zoom animieren
                view.animate({
                    resolution: resolution,
                    duration: 250
                });
            };
            
            // Nächsten vordefinierten Maßstab finden
            function findClosestScale(actualScale) {
                var closest = predefinedScales[0];
                var minDiff = Math.abs(actualScale - closest);
                
                for (var i = 1; i < predefinedScales.length; i++) {
                    var diff = Math.abs(actualScale - predefinedScales[i]);
                    if (diff < minDiff) {
                        minDiff = diff;
                        closest = predefinedScales[i];
                    }
                }
                return closest;
            }
            
            // Maßstab im Footer aktualisieren (Dropdown)
            function updateScaleDisplay() {
                var scaleSelect = document.getElementById('map-scale-select');
                if (!scaleSelect) {
                    console.log('Scale: Element #map-scale-select nicht gefunden');
                    return;
                }
                
                if (njs && njs.AppManager && njs.AppManager.Maps && njs.AppManager.Maps['main'] && njs.AppManager.Maps['main'].mapObj) {
                    var map = njs.AppManager.Maps['main'].mapObj;
                    var scale = getMapScale(map);
                    
                    if (!scale) {
                        console.log('Scale: Konnte Maßstab nicht berechnen');
                        return;
                    }
                    
                    // Nächsten vordefinierten Maßstab finden und im Dropdown auswählen
                    var closestScale = findClosestScale(scale);
                    scaleSelect.value = closestScale.toString();
                } else {
                    console.log('Scale: Map nicht verfügbar');
                }
            }
            
            // Copyright aus disclaimer_copyright übernehmen
            function updateCopyrightDisplay() {
                var copyrightTarget = document.getElementById('map-footer-copyright');
                var copyrightSource = document.getElementById('disclaimer_copyright');
                
                if (copyrightTarget && copyrightSource && copyrightSource.textContent.trim()) {
                    copyrightTarget.textContent = copyrightSource.textContent.trim();
                }
            }
            
            // Initialisieren wenn DOM bereit
            console.log('Footer Bar: Warte auf DOM...');
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('Footer Bar: DOMContentLoaded');
                    setupObservers();
                });
            } else {
                console.log('Footer Bar: DOM bereits geladen');
                setupObservers();
            }
        })();

        // ===== RECHTSKLICK-KONTEXTMENÜ =====
        (function() {
            var contextMenu = null;
            var ctxCoordsDisplay = null;
            var clickedCoords = null; // {lv95: [E, N], wgs84: [lon, lat], pixel: [x, y]}
            
            // Warte auf Map UND DOM
            function waitForMapAndDOM(callback) {
                var mapReady = njs && njs.AppManager && njs.AppManager.Maps && njs.AppManager.Maps['main'] && njs.AppManager.Maps['main'].mapObj;
                var domReady = document.getElementById('map-context-menu') && document.getElementById('map');
                
                if (mapReady && domReady) {
                    callback(njs.AppManager.Maps['main']);
                } else {
                    setTimeout(function() { waitForMapAndDOM(callback); }, 300);
                }
            }
            
            // Proj4 Transformation LV95 <-> WGS84
            function lv95ToWgs84(e, n) {
                // Vereinfachte Näherung für Schweiz
                var y_aux = (e - 2600000) / 1000000;
                var x_aux = (n - 1200000) / 1000000;
                
                var lon = 2.6779094 
                    + 4.728982 * y_aux 
                    + 0.791484 * y_aux * x_aux 
                    + 0.1306 * y_aux * Math.pow(x_aux, 2) 
                    - 0.0436 * Math.pow(y_aux, 3);
                
                var lat = 16.9023892 
                    + 3.238272 * x_aux 
                    - 0.270978 * Math.pow(y_aux, 2) 
                    - 0.002528 * Math.pow(x_aux, 2) 
                    - 0.0447 * Math.pow(y_aux, 2) * x_aux 
                    - 0.0140 * Math.pow(x_aux, 3);
                
                lon = lon * 100 / 36;
                lat = lat * 100 / 36;
                
                return [lon, lat];
            }
            
            // Toast anzeigen
            function showToast(message) {
                var existing = document.querySelector('.ctx-toast');
                if (existing) existing.remove();
                
                var toast = document.createElement('div');
                toast.className = 'ctx-toast';
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(function() {
                    toast.classList.add('fade-out');
                    setTimeout(function() { toast.remove(); }, 300);
                }, 2000);
            }
            
            // Menü ausblenden
            window.hideContextMenu = function() {
                if (contextMenu) contextMenu.classList.remove('show');
            };
            
            // Gemeinsame Marker-Funktion (wird von Linksklick UND Kontextmenü verwendet)
            function setMarkerAtPosition(coords) {
                if (!coords || !coords.lv95) return;
                
                if (njs && njs.AppManager && njs.AppManager.Maps && njs.AppManager.Maps['main']) {
                    var mapWrapper = njs.AppManager.Maps['main'];
                    var map = mapWrapper.mapObj;
                    
                    if (!map || typeof ol === 'undefined') return;
                    
                    // Marker-Layer erstellen falls nicht vorhanden
                    if (!window.userMarkerLayer) {
                        window.userMarkerLayer = new ol.layer.Vector({
                            source: new ol.source.Vector(),
                            zIndex: 999
                        });
                        map.addLayer(window.userMarkerLayer);
                    }
                    
                    // Alten Marker entfernen (nur ein aktiver Marker)
                    window.userMarkerLayer.getSource().clear();
                    
                    // Marker-Style mit externem SVG-Pin
                    var markerStyle = new ol.style.Style({
                        image: new ol.style.Icon({
                            anchor: [0.5, 1],
                            anchorXUnits: 'fraction',
                            anchorYUnits: 'fraction',
                            src: '/maps/tnet/resources/icons/marker-pin.svg',
                            scale: 0.75
                        })
                    });
                    
                    var feature = new ol.Feature({
                        geometry: new ol.geom.Point(coords.lv95),
                        name: 'Marker',
                        coords: coords
                    });
                    feature.setStyle(markerStyle);
                    
                    window.userMarkerLayer.getSource().addFeature(feature);
                }
            }
            
            // Globale Funktion für externe Aufrufe
            window.setMarkerAtPosition = setMarkerAtPosition;
            
            // Bei Klick außerhalb oder Escape schließen
            document.addEventListener('click', function(e) {
                if (contextMenu && !contextMenu.contains(e.target)) {
                    hideContextMenu();
                }
            });
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') hideContextMenu();
            });
            
            // Map Rechtsklick
            waitForMapAndDOM(function(mapWrapper) {
                contextMenu = document.getElementById('map-context-menu');
                ctxCoordsDisplay = document.getElementById('ctx-coords-display');
                
                var map = mapWrapper.mapObj; // OpenLayers Map
                if (!map) {
                    console.error('Context Menu: OpenLayers map nicht gefunden');
                    return;
                }
                
                var mapEl = document.getElementById('map');
                if (!mapEl) {
                    console.error('Context Menu: Map Element nicht gefunden');
                    return;
                }
                
                console.log('Context Menu: Initialisiert auf', mapEl);
                
                // Event direkt auf das canvas Element mit capture
                function handleContextMenu(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    
                    console.log('Context Menu: Rechtsklick bei', e.clientX, e.clientY);
                    
                    // Pixel-Koordinaten
                    var rect = mapEl.getBoundingClientRect();
                    var pixel = [e.clientX - rect.left, e.clientY - rect.top];
                    
                    // Koordinaten aus Map holen (LV95)
                    var coord = map.getCoordinateFromPixel(pixel);
                    if (!coord) {
                        console.log('Context Menu: Keine Koordinaten');
                        return false;
                    }
                    
                    var lv95 = [Math.round(coord[0]), Math.round(coord[1])];
                    var wgs84 = lv95ToWgs84(coord[0], coord[1]);
                    
                    clickedCoords = {
                        lv95: lv95,
                        wgs84: wgs84,
                        pixel: pixel
                    };
                    
                    // Koordinaten im Header anzeigen
                    if (ctxCoordsDisplay) {
                        ctxCoordsDisplay.textContent = lv95[0].toLocaleString('de-CH') + ' / ' + lv95[1].toLocaleString('de-CH');
                    }
                    
                    console.log('Context Menu: Koordinaten', lv95);
                    
                    // Position des Menüs
                    var menuWidth = 240;
                    var menuHeight = 380;
                    var posX = e.clientX;
                    var posY = e.clientY;
                    
                    // Am rechten Rand anpassen
                    if (posX + menuWidth > window.innerWidth) {
                        posX = window.innerWidth - menuWidth - 10;
                    }
                    // Am unteren Rand anpassen
                    if (posY + menuHeight > window.innerHeight) {
                        posY = window.innerHeight - menuHeight - 10;
                    }
                    
                    contextMenu.style.left = posX + 'px';
                    contextMenu.style.top = posY + 'px';
                    contextMenu.classList.add('show');
                    
                    console.log('Context Menu: Angezeigt');
                    return false;
                }
                
                // Event auf mapEl mit capture:true (fängt Event vor OpenLayers)
                mapEl.addEventListener('contextmenu', handleContextMenu, true);
                
                // Auch auf document als Fallback
                document.addEventListener('contextmenu', function(e) {
                    // Nur wenn innerhalb des Map-Containers
                    if (mapEl.contains(e.target) || e.target === mapEl) {
                        handleContextMenu(e);
                    }
                }, true);
                
                // Linksklick auf Karte: Marker setzen
                map.on('singleclick', function(evt) {
                    // Koordinaten aus Event
                    var coord = evt.coordinate;
                    if (!coord) return;
                    
                    var lv95 = [Math.round(coord[0]), Math.round(coord[1])];
                    var wgs84 = lv95ToWgs84(coord[0], coord[1]);
                    
                    var coords = {
                        lv95: lv95,
                        wgs84: wgs84,
                        pixel: evt.pixel
                    };
                    
                    // Marker an Klickposition setzen
                    setMarkerAtPosition(coords);
                });
            });
            
            // Menü-Aktionen
            window.ctxCopyCoords = function(format) {
                if (!clickedCoords) return;
                var text;
                if (format === 'lv95') {
                    // Versuche zuerst aus bestehendem Input-Feld zu lesen
                    var lv95Input = document.getElementById('xy_coord2');
                    if (lv95Input && lv95Input.value) {
                        text = lv95Input.value;
                    } else {
                        text = clickedCoords.lv95[0] + ', ' + clickedCoords.lv95[1];
                    }
                    showToast('LV95 kopiert: ' + text);
                } else {
                    // Versuche zuerst aus bestehendem Input-Feld zu lesen
                    var wgs84Input = document.getElementById('xy_coord3');
                    if (wgs84Input && wgs84Input.value) {
                        text = wgs84Input.value;
                    } else {
                        text = clickedCoords.wgs84[1].toFixed(6) + ', ' + clickedCoords.wgs84[0].toFixed(6);
                    }
                    showToast('WGS84 kopiert: ' + text);
                }
                navigator.clipboard.writeText(text);
                hideContextMenu();
            };
            
            // Koordinaten fixieren (Picker toggle)
            window.ctxFixCoords = function() {
                hideContextMenu();
                // Toggle den CoordDisplay Picker
                if (njs && njs.AppManager && njs.AppManager.Tools && 
                    njs.AppManager.Tools.CoordDisplay && 
                    njs.AppManager.Tools.CoordDisplay['map'] && 
                    njs.AppManager.Tools.CoordDisplay['map']['coord2']) {
                    njs.AppManager.Tools.CoordDisplay['map']['coord2'].togglePicker('map');
                    showToast('Koordinaten-Anzeige fixiert');
                } else {
                    // Fallback: Klick auf Picker-Button simulieren
                    var pickerBtn = document.getElementById('coord2_picker');
                    if (pickerBtn) {
                        pickerBtn.click();
                        showToast('Koordinaten-Anzeige fixiert');
                    }
                }
            };
            
            window.ctxWhatIsHere = function() {
                if (!clickedCoords) return;
                hideContextMenu();
                
                // Marker setzen an der Position
                setMarkerAtPosition(clickedCoords);
                
                // Feature-Info an Position abfragen (simuliere Linksklick)
                if (njs && njs.AppManager && njs.AppManager.Maps && njs.AppManager.Maps['main']) {
                    var mapWrapper = njs.AppManager.Maps['main'];
                    var map = mapWrapper.mapObj;
                    
                    if (map) {
                        // Simuliere singleclick Event an der Position
                        map.dispatchEvent({
                            type: 'singleclick', 
                            coordinate: clickedCoords.lv95, 
                            pixel: clickedCoords.pixel,
                            originalEvent: { preventDefault: function(){}, stopPropagation: function(){} }
                        });
                    }
                }
            };
            
            window.ctxZoomHere = function() {
                if (!clickedCoords) return;
                hideContextMenu();
                if (njs && njs.AppManager && njs.AppManager.Maps && njs.AppManager.Maps['main']) {
                    var map = njs.AppManager.Maps['main'].mapObj;
                    if (map) {
                        var view = map.getView();
                        view.animate({
                            center: clickedCoords.lv95,
                            zoom: Math.max(view.getZoom() + 2, 15),
                            duration: 500
                        });
                    }
                }
            };
            
            window.ctxSetMarker = function() {
                if (!clickedCoords) return;
                hideContextMenu();
                setMarkerAtPosition(clickedCoords);
                showToast('Marker gesetzt');
            };
            
            window.ctxRouteFrom = function() {
                if (!clickedCoords) return;
                hideContextMenu();
                // Routing-Start setzen
                showToast('Start-Position gesetzt: ' + clickedCoords.lv95[0] + ', ' + clickedCoords.lv95[1]);
                window.routeStartCoords = clickedCoords;
                // Falls Routing-Modul vorhanden
                if (njs && njs.AppManager && njs.AppManager.getModule) {
                    var routing = njs.AppManager.getModule('routing');
                    if (routing && routing.setStart) {
                        routing.setStart(clickedCoords.lv95);
                    }
                }
            };
            
            window.ctxRouteTo = function() {
                if (!clickedCoords) return;
                hideContextMenu();
                // Routing-Ziel setzen
                showToast('Ziel-Position gesetzt: ' + clickedCoords.lv95[0] + ', ' + clickedCoords.lv95[1]);
                window.routeEndCoords = clickedCoords;
                // Falls Routing-Modul vorhanden
                if (njs && njs.AppManager && njs.AppManager.getModule) {
                    var routing = njs.AppManager.getModule('routing');
                    if (routing && routing.setEnd) {
                        routing.setEnd(clickedCoords.lv95);
                    }
                }
            };
            
            window.ctxOpenGoogleMaps = function() {
                if (!clickedCoords) return;
                hideContextMenu();
                var lat = clickedCoords.wgs84[1].toFixed(6);
                var lon = clickedCoords.wgs84[0].toFixed(6);
                var url = 'https://www.google.com/maps?q=' + lat + ',' + lon + '&z=18';
                window.open(url, '_blank');
            };
            
            window.ctxOpenStreetView = function() {
                if (!clickedCoords) return;
                hideContextMenu();
                var lat = clickedCoords.wgs84[1].toFixed(6);
                var lon = clickedCoords.wgs84[0].toFixed(6);
                var url = 'https://www.google.com/maps?layer=c&cbll=' + lat + ',' + lon;
                window.open(url, '_blank');
            };
            
            window.ctxCopyLink = function() {
                hideContextMenu();
                // Einfach die aktuelle URL kopieren (enthält bereits alle Parameter)
                var currentUrl = window.location.href;
                navigator.clipboard.writeText(currentUrl);
                showToast('URL kopiert!');
            };
        })();
    </script>


</body>

</html>